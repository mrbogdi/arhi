<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORE-ARCH OS v5.0 | Quantum Sentinel Engineering</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap');
        
        :root {
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.4);
            --bg-glass: rgba(255, 255, 255, 0.45);
            --neon-cyan: #22d3ee;
            --neon-rose: #f43f5e;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: radial-gradient(circle at top right, #f8fafc, #cbd5e1, #94a3b8);
            background-attachment: fixed;
            color: #0f172a;
            overflow-x: hidden;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Glassmorphism Ultra 2026 */
        .glass {
            background: var(--bg-glass);
            backdrop-filter: blur(25px) saturate(200%);
            -webkit-backdrop-filter: blur(25px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        .glass-dark {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .neo-button {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .neo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px var(--accent-glow);
        }

        .shimmer-text {
            background: linear-gradient(90deg, #6366f1, #22d3ee, #6366f1);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 3s linear infinite;
        }

        @keyframes shine { to { background-position: 200% center; } }

        .scan-line {
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--neon-cyan), transparent);
            position: absolute;
            top: 0;
            animation: scan 3s linear infinite;
            z-index: 20;
        }

        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .hologram-grid {
            background-image: radial-gradient(rgba(99, 102, 241, 0.1) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen text-slate-900 hologram-grid">

    <nav class="fixed top-0 w-full z-50 px-6 py-4">
        <div class="max-w-[1850px] mx-auto flex justify-between items-center glass rounded-2xl px-6 py-3 shadow-2xl">
            <div class="flex items-center gap-6">
                <div class="p-2.5 bg-slate-900 rounded-xl shadow-lg relative group cursor-pointer">
                    <i data-lucide="box" class="text-indigo-400 w-6 h-6 group-hover:rotate-90 transition-transform duration-500"></i>
                    <div class="absolute -inset-1 bg-indigo-500 rounded-xl blur opacity-25 group-hover:opacity-50 transition"></div>
                </div>
                <div>
                    <span class="font-black text-2xl tracking-tighter uppercase flex items-center gap-2">
                        CORE-ARCH <span class="bg-indigo-600 text-white px-2 py-0.5 rounded-md text-sm">V5.0</span>
                    </span>
                    <span class="block text-[8px] font-bold text-slate-500 tracking-[0.4em] uppercase">Quantum Engineering Sentinel</span>
                </div>
            </div>

            <div class="hidden xl:flex gap-10 items-center">
                <div class="flex gap-8">
                    <div class="text-left">
                        <p class="text-[8px] font-bold text-slate-400 uppercase">Neural Load</p>
                        <div class="flex items-center gap-2">
                            <p class="text-xs font-mono font-bold text-indigo-600">42.8 TFlops</p>
                            <div class="w-12 h-1 bg-slate-200 rounded-full overflow-hidden">
                                <div class="bg-indigo-500 h-full w-[65%] animate-pulse"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-left border-l border-slate-200 pl-8">
                        <p class="text-[8px] font-bold text-slate-400 uppercase">Embodied Carbon</p>
                        <p class="text-xs font-mono font-bold text-emerald-600">-12.4% Net</p>
                    </div>
                    <div class="text-left border-l border-slate-200 pl-8">
                        <p class="text-[8px] font-bold text-slate-400 uppercase">Structural Risk</p>
                        <p class="text-xs font-mono font-bold text-rose-500">Minimal (0.02)</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="flex -space-x-2">
                        <div class="w-7 h-7 rounded-full border-2 border-white bg-indigo-100 flex items-center justify-center text-[10px] font-bold">AI</div>
                        <div class="w-7 h-7 rounded-full border-2 border-white bg-slate-800 flex items-center justify-center text-[10px] text-white font-bold">JD</div>
                    </div>
                    <div id="connection-status" class="flex items-center gap-2 px-4 py-1.5 bg-white/50 rounded-full border border-indigo-100">
                        <span class="status-dot bg-emerald-500 animate-ping"></span>
                        <span class="text-[9px] font-black text-slate-700 uppercase tracking-widest">Neural Link Active</span>
                    </div>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="toggleVisualMode()" class="p-3 glass rounded-xl hover:bg-white transition shadow-sm" title="Switch 3D View Mode">
                    <i data-lucide="layers-2" class="w-5 h-5 text-indigo-600"></i>
                </button>
                <button onclick="toggleAudit()" class="p-3 bg-slate-900 text-white rounded-xl hover:bg-indigo-600 transition shadow-xl">
                    <i data-lucide="fingerprint" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-[1850px] mx-auto pt-28 px-6 pb-12">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <div class="glass p-5 rounded-[2rem] border-l-4 border-indigo-500 hover-lift">
                <div class="flex justify-between items-start mb-2">
                    <div class="p-2.5 bg-indigo-50 rounded-xl text-indigo-600"><i data-lucide="database" class="w-5 h-5"></i></div>
                    <span class="text-[10px] font-bold text-emerald-500">+2.4%</span>
                </div>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Neural Dataset</p>
                <p class="text-xl font-black">18.2 PB</p>
            </div>
            <div class="glass p-5 rounded-[2rem] border-l-4 border-emerald-500 hover-lift">
                <div class="flex justify-between items-start mb-2">
                    <div class="p-2.5 bg-emerald-50 rounded-xl text-emerald-600"><i data-lucide="leaf" class="w-5 h-5"></i></div>
                    <span class="text-[10px] font-bold text-emerald-500">LEED A+</span>
                </div>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Eco-Index</p>
                <p class="text-xl font-black">0.94 <span class="text-xs font-normal text-slate-400">GWP</span></p>
            </div>
            <div class="glass p-5 rounded-[2rem] border-l-4 border-amber-500 hover-lift">
                <div class="flex justify-between items-start mb-2">
                    <div class="p-2.5 bg-amber-50 rounded-xl text-amber-600"><i data-lucide="cpu" class="w-5 h-5"></i></div>
                    <span class="text-[10px] font-bold text-slate-400">Syncing</span>
                </div>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Compute Nodes</p>
                <p class="text-xl font-black">128 <span class="text-xs font-normal text-slate-400">Cores</span></p>
            </div>
            <div class="glass p-5 rounded-[2rem] border-l-4 border-rose-500 hover-lift">
                <div class="flex justify-between items-start mb-2">
                    <div class="p-2.5 bg-rose-50 rounded-xl text-rose-600"><i data-lucide="alert-octagon" class="w-5 h-5"></i></div>
                    <span class="text-[10px] font-bold text-rose-500">High</span>
                </div>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Structural Stress</p>
                <p class="text-xl font-black">04 <span class="text-xs font-normal text-slate-400">Nodes</span></p>
            </div>
            <div class="glass p-5 rounded-[2rem] border-l-4 border-cyan-500 hover-lift">
                <div class="flex justify-between items-start mb-2">
                    <div class="p-2.5 bg-cyan-50 rounded-xl text-cyan-600"><i data-lucide="clock" class="w-5 h-5"></i></div>
                    <span class="text-[10px] font-bold text-cyan-500">Live</span>
                </div>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">BIM LOD</p>
                <p class="text-xl font-black">500+</p>
            </div>
        </div>

        <div class="grid grid-cols-12 gap-8">
            
            <aside class="col-span-12 lg:col-span-3 space-y-6">
                <div class="glass p-6 rounded-[2.5rem] shadow-sm relative overflow-hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em]">Quantum Library</h3>
                        <span class="bg-indigo-600 text-white text-[10px] px-2.5 py-1 rounded-lg font-bold" id="module-count">...</span>
                    </div>
                    
                    <div class="relative mb-6">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-indigo-400"></i>
                        <input type="text" id="searchModules" oninput="filterModules()" placeholder="Căutare rapidă (Ctrl+K)..." 
                               class="w-full bg-white/60 border border-white rounded-2xl py-4 pl-12 text-sm focus:ring-4 focus:ring-indigo-500/10 transition-all outline-none">
                    </div>

                    <div id="module-list" class="space-y-2 h-[550px] overflow-y-auto pr-2 custom-scrollbar">
                        </div>
                </div>

                <div class="glass-dark p-8 rounded-[2.5rem] text-white relative overflow-hidden group">
                    <div class="relative z-10">
                        <h3 class="text-xl font-black mb-2 flex items-center gap-2">
                            Neural Forge <i data-lucide="zap" class="w-4 h-4 text-amber-400"></i>
                        </h3>
                        <p class="text-slate-400 text-xs mb-6 leading-relaxed">Generare automată de scripturi de calcul prin procesare limbaj natural și Math.js.</p>
                        <button onclick="openForge()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold text-xs hover:bg-white hover:text-slate-900 transition-all uppercase tracking-[0.2em] shadow-lg shadow-indigo-500/20">Deschide Terminal Forge</button>
                    </div>
                    <div class="absolute -right-8 -bottom-8 opacity-10 group-hover:scale-110 transition-transform duration-700">
                        <i data-lucide="brain-circuit" class="w-40 h-40"></i>
                    </div>
                </div>
            </aside>

            <main class="col-span-12 lg:col-span-6 space-y-8">
                <div class="glass rounded-[3rem] p-3 relative shadow-2xl border border-white">
                    <div id="three-container" class="w-full h-[450px] relative bg-slate-950 rounded-[2.6rem] overflow-hidden group">
                        <div class="scan-line"></div>
                        <div class="absolute top-8 left-8 z-10 space-y-3">
                            <div class="bg-black/40 backdrop-blur-xl px-4 py-2 rounded-xl border border-white/10 flex items-center gap-3">
                                <span class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></span>
                                <span id="view-mode-text" class="text-[10px] font-black text-white uppercase tracking-widest">Spectral Analysis View</span>
                            </div>
                            <div class="flex gap-2">
                                <span class="px-3 py-1 rounded-lg bg-emerald-500/20 text-emerald-400 text-[9px] font-bold border border-emerald-500/30 uppercase">FEA Active</span>
                                <span class="px-3 py-1 rounded-lg bg-indigo-500/20 text-indigo-400 text-[9px] font-bold border border-indigo-500/30 uppercase">Topology OK</span>
                            </div>
                        </div>

                        <div class="absolute bottom-8 right-8 z-10 flex flex-col items-end gap-2">
                            <div class="bg-black/40 backdrop-blur-md p-4 rounded-2xl border border-white/10 text-right">
                                <p class="text-[8px] font-bold text-slate-400 uppercase">Current Strain</p>
                                <p class="text-lg font-mono text-white font-black" id="live-strain">0.00012 ε</p>
                            </div>
                        </div>

                        <canvas id="three-canvas" class="w-full h-full cursor-crosshair"></canvas>
                    </div>
                </div>

                <div id="calc-display" class="glass rounded-[3rem] p-10 min-h-[500px] shadow-sm relative overflow-hidden border border-white">
                    <div id="empty-state" class="flex flex-col items-center justify-center h-full text-center space-y-8 py-20">
                        <div class="relative">
                            <div class="w-28 h-28 bg-white rounded-[2.5rem] shadow-2xl flex items-center justify-center animate-bounce">
                                <i data-lucide="binary" class="w-14 h-14 text-indigo-500"></i>
                            </div>
                            <div class="absolute -top-2 -right-2 w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center text-white shadow-lg border-4 border-white">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </div>
                        </div>
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 tracking-tighter">Sistemul este Ready.</h2>
                            <p class="text-slate-400 text-sm max-w-sm mx-auto mt-2 font-medium">Inițiați un protocol de calcul din librărie pentru a activa motorul cinematic v5.0.</p>
                        </div>
                        <div class="flex gap-4">
                            <div class="px-6 py-3 bg-slate-100 rounded-2xl text-[10px] font-black uppercase text-slate-500">Auto-Save Enabled</div>
                            <div class="px-6 py-3 bg-indigo-50 rounded-2xl text-[10px] font-black uppercase text-indigo-500">Quantum Sync Active</div>
                        </div>
                    </div>

                    <div id="active-calc-ui" class="hidden">
                        </div>
                </div>
            </main>

            <aside class="col-span-12 lg:col-span-3 space-y-6">
                <div class="glass p-6 rounded-[2.5rem] relative overflow-hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Neural Advisor</h3>
                        <div class="bg-indigo-100 p-2 rounded-lg"><i data-lucide="sparkles" class="w-4 h-4 text-indigo-600"></i></div>
                    </div>
                    <div id="advisor-content" class="text-xs text-slate-600 leading-relaxed font-medium p-5 bg-white/60 rounded-[1.5rem] border border-white shadow-inner italic">
                        Selectați un modul pentru analiză contextuală bazată pe BIM 2026.
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-200">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[9px] font-black uppercase text-slate-400">Optimization Confidence</span>
                            <span class="text-[9px] font-black text-indigo-600">98%</span>
                        </div>
                        <div class="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full bg-indigo-500 w-[98%] rounded-full"></div>
                        </div>
                    </div>
                </div>

                <div class="glass p-6 rounded-[2.5rem]">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-6">Material Multi-Stack</h3>
                    <div class="space-y-3" id="material-list">
                        </div>
                </div>

                <div class="glass p-8 rounded-[2.5rem] bg-gradient-to-br from-indigo-600 to-indigo-900 text-white shadow-2xl shadow-indigo-200">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h4 class="text-lg font-black tracking-tight">SkyTower Neo</h4>
                            <p class="text-[10px] text-indigo-200 uppercase font-bold tracking-widest">Global Manifest v9.2</p>
                        </div>
                        <i data-lucide="building-2" class="w-6 h-6 text-indigo-300"></i>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between text-[10px] mb-2 font-black uppercase">
                                <span>Structural Health</span>
                                <span class="text-emerald-400">99.4%</span>
                            </div>
                            <div class="w-full bg-white/10 h-2 rounded-full overflow-hidden">
                                <div class="bg-emerald-400 w-[99%] h-full"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white/5 p-3 rounded-2xl border border-white/10">
                                <p class="text-[8px] text-indigo-200 font-bold uppercase">Budget Flux</p>
                                <p class="text-sm font-black">+2.1%</p>
                            </div>
                            <div class="bg-white/5 p-3 rounded-2xl border border-white/10">
                                <p class="text-[8px] text-indigo-200 font-bold uppercase">Material Efficiency</p>
                                <p class="text-sm font-black">0.88</p>
                            </div>
                        </div>
                        <button class="w-full py-4 bg-white text-indigo-900 text-xs font-black rounded-2xl uppercase tracking-[0.2em] hover:bg-indigo-50 transition-colors shadow-lg">Download 4D Model</button>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <div id="forge-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 bg-slate-900/80 backdrop-blur-xl">
        <div class="glass w-full max-w-2xl rounded-[3rem] shadow-2xl overflow-hidden border border-white/20">
            <div class="p-10 border-b flex justify-between items-center bg-white/40">
                <div>
                    <h2 class="text-3xl font-black italic tracking-tighter">Neural <span class="text-indigo-600">Forge</span></h2>
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Integrated Math Engine v11.2</p>
                </div>
                <button onclick="closeForge()" class="p-3 hover:bg-rose-50 hover:text-rose-500 rounded-full transition-all"><i data-lucide="x"></i></button>
            </div>
            <div class="p-10 space-y-8">
                <div class="grid grid-cols-2 gap-8">
                    <div class="space-y-3">
                        <label class="text-[10px] font-black uppercase ml-1 text-slate-400">Modul Denumire</label>
                        <input id="forge-name" type="text" class="w-full p-5 bg-white/80 rounded-2xl border-none focus:ring-4 focus:ring-indigo-500/10 shadow-sm font-bold" placeholder="Ex: Shear Resistance">
                    </div>
                    <div class="space-y-3">
                        <label class="text-[10px] font-black uppercase ml-1 text-slate-400">Categorie Analiză</label>
                        <select id="forge-cat" class="w-full p-5 bg-white/80 rounded-2xl border-none focus:ring-4 focus:ring-indigo-500/10 shadow-sm font-bold">
                            <option>Structural</option>
                            <option>Thermal</option>
                            <option>Seismic</option>
                            <option>Aerodynamics</option>
                        </select>
                    </div>
                </div>
                <div class="space-y-3">
                    <label class="text-[10px] font-black uppercase ml-1 text-slate-400">Script Matematic (Parametri: p0, p1, p2...)</label>
                    <div class="relative">
                        <input id="forge-formula" type="text" class="w-full p-6 mono bg-slate-900 text-cyan-400 rounded-3xl border-none text-xl shadow-2xl" placeholder="p0 * 250 / (p1 + 0.01)">
                        <div class="absolute right-6 top-1/2 -translate-y-1/2 text-slate-600 font-mono text-xs uppercase">Engine v5.0</div>
                    </div>
                </div>
                <button onclick="buildModule()" class="w-full py-6 bg-slate-900 text-white rounded-[2rem] font-black hover:bg-indigo-600 transition-all shadow-xl uppercase tracking-[0.3em]">Compile & Deploy Module</button>
            </div>
        </div>
    </div>

    <div id="audit-overlay" class="fixed inset-0 bg-slate-900/40 backdrop-blur-3xl z-[200] hidden">
        <div class="max-w-5xl mx-auto mt-20 glass h-[75vh] rounded-[3rem] shadow-2xl overflow-hidden flex flex-col border border-white">
            <div class="p-10 border-b flex justify-between items-center bg-slate-950 text-white">
                <div>
                    <h2 class="text-3xl font-black tracking-tighter uppercase">Audit Trail & Neural Logs</h2>
                    <p class="text-[10px] text-indigo-400 font-mono tracking-[0.3em] uppercase">AES-256 Encrypted Session</p>
                </div>
                <button onclick="toggleAudit()" class="p-4 bg-white/10 hover:bg-rose-500 rounded-2xl transition-all">✕</button>
            </div>
            <div id="audit-logs" class="p-10 overflow-y-auto space-y-4 font-mono text-xs">
                </div>
        </div>
    </div>

    <script>
        // --- 2026 ENHANCED DATA ENGINE ---
        const materials = [
            { name: "UHPC Graphene+", e: "60 GPa", density: "2600 kg/m³", icon: "shield-check", advisor: "Beton de ultra-înaltă performanță armat cu grafen. Excelent pentru secțiuni subțiri." },
            { name: "Smart Steel S460", e: "210 GPa", density: "7850 kg/m³", icon: "layers", advisor: "Oțel inteligent cu senzori de coroziune integrați. Utilizare structurală optimă." },
            { name: "Mycelium Bio-Brick", e: "0.5 GPa", density: "150 kg/m³", icon: "leaf", advisor: "Material biologic pentru izolare și pereți despărțitori. Amprentă de carbon negativă." },
            { name: "Aerogel Glass v4", e: "15 GPa", density: "1200 kg/m³", icon: "sun", advisor: "Transluciditate maximă cu izolare termică de nivel spațial (U < 0.2)." }
        ];

        let calculators = [
            { id: 'seismic-t', cat: 'Seismic', name: 'Torsional Sensitivity', icon: 'rotate-cw', params: ['Mass Ecc (m)', 'Base Shear (kN)', 'Radius of Gyration'], formula: 'p1 * p0 * p2 / 1.5', shape: 'torus' },
            { id: 'wind-v5', cat: 'Aerodynamics', name: 'Vortex Shedding', icon: 'wind', params: ['Wind Vel (m/s)', 'Width (m)', 'Strouhal No'], formula: '(p2 * p0) / p1', shape: 'sphere' },
            { id: 'thermal-bridge', cat: 'Thermal', name: 'Thermal Bridge Loss', icon: 'thermometer-snowflake', params: ['Length (m)', 'Psi Value', 'ΔT (K)'], formula: 'p0 * p1 * p2', shape: 'box' },
            { id: 'carbon-emb', cat: 'Sustainability', name: 'Embodied Carbon Hub', icon: 'leaf', params: ['Volume (m3)', 'ECF Index', 'Recycle %'], formula: 'p0 * p1 * (1 - p2/100)', shape: 'octahedron' },
            { id: 'cost-quant', cat: 'Economic', name: 'Quantum Cost Index', icon: 'trending-up', params: ['Complexity (1-10)', 'Vol (m3)', 'Market Factor'], formula: 'p0 * p1 * 2450 * p2', shape: 'torus-knot' }
        ];

        // --- 3D ENGINE 2026 (WITH MODES) ---
        let scene, camera, renderer, object, material3d;
        let viewMode = 'spectral'; // spectral, xray, stress

        function init3D() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('three-canvas'), antialias: true, alpha: true });
            
            const container = document.getElementById('three-container');
            renderer.setSize(container.clientWidth, container.clientHeight);

            updateGeometry('torus-knot');
            
            const pLight = new THREE.PointLight(0x6366f1, 2, 100);
            pLight.position.set(10, 10, 10);
            scene.add(pLight);
            
            const aLight = new THREE.AmbientLight(0x404040, 2);
            scene.add(aLight);

            camera.position.z = 12;
            animate();
        }

        function updateGeometry(type) {
            if (object) scene.remove(object);
            let geo;
            switch(type) {
                case 'box': geo = new THREE.BoxGeometry(4, 4, 4); break;
                case 'sphere': geo = new THREE.SphereGeometry(3.5, 64, 64); break;
                case 'octahedron': geo = new THREE.OctahedronGeometry(4); break;
                case 'torus-knot': geo = new THREE.TorusKnotGeometry(2.5, 0.8, 200, 32); break;
                default: geo = new THREE.TorusKnotGeometry(2.5, 0.8, 200, 32);
            }
            
            applyViewModeMaterial();
            object = new THREE.Mesh(geo, material3d);
            scene.add(object);
        }

        function applyViewModeMaterial() {
            switch(viewMode) {
                case 'xray':
                    material3d = new THREE.MeshPhongMaterial({ color: 0x22d3ee, wireframe: true, transparent: true, opacity: 0.3, emissive: 0x22d3ee });
                    break;
                case 'stress':
                    material3d = new THREE.MeshNormalMaterial({ wireframe: false });
                    break;
                default: // spectral
                    material3d = new THREE.MeshStandardMaterial({ color: 0x6366f1, wireframe: true, emissive: 0x111111, roughness: 0.1 });
            }
            if(object) object.material = material3d;
        }

        function toggleVisualMode() {
            const modes = ['spectral', 'xray', 'stress'];
            let idx = modes.indexOf(viewMode);
            viewMode = modes[(idx + 1) % modes.length];
            applyViewModeMaterial();
            document.getElementById('view-mode-text').innerText = `${viewMode.toUpperCase()} ANALYSIS ACTIVE`;
            logAction('VISUAL_MODE_CHANGE', { mode: viewMode });
        }

        function animate() {
            requestAnimationFrame(animate);
            if(object) {
                object.rotation.y += 0.003;
                object.rotation.x += 0.001;
            }
            renderer.render(scene, camera);
        }

        // --- UI CORE LOGIC ---
        function renderLibrary(filter = '') {
            const list = document.getElementById('module-list');
            list.innerHTML = '';
            const cats = [...new Set(calculators.map(c => c.cat))];

            cats.forEach(cat => {
                const filtered = calculators.filter(c => c.cat === cat && c.name.toLowerCase().includes(filter.toLowerCase()));
                if(filtered.length === 0) return;

                const head = document.createElement('div');
                head.className = "py-4 px-2 text-[8px] font-black text-slate-400 uppercase tracking-[0.3em]";
                head.innerText = cat;
                list.appendChild(head);

                filtered.forEach(calc => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left px-5 py-5 rounded-[1.5rem] text-xs font-bold text-slate-600 hover:bg-white hover:text-indigo-600 hover:shadow-xl transition-all flex items-center gap-4 group border border-transparent hover:border-indigo-100";
                    btn.onclick = () => loadModule(calc.id);
                    btn.innerHTML = `
                        <div class="p-2.5 bg-slate-100 rounded-xl group-hover:bg-indigo-50 transition-colors">
                            <i data-lucide="${calc.icon}" class="w-4 h-4 text-slate-500 group-hover:text-indigo-600"></i>
                        </div>
                        <div class="flex-1">
                            <span class="block">${calc.name}</span>
                            <span class="text-[8px] text-slate-400 font-normal uppercase tracking-tighter">V5.0 Compliant</span>
                        </div>
                        <i data-lucide="arrow-right" class="w-3 h-3 opacity-0 group-hover:opacity-100 transition-all"></i>
                    `;
                    list.appendChild(btn);
                });
            });
            lucide.createIcons();
            document.getElementById('module-count').innerText = `${calculators.length} Module`;
        }

        function loadModule(id) {
            const calc = calculators.find(c => c.id === id);
            document.getElementById('empty-state').classList.add('hidden');
            const ui = document.getElementById('active-calc-ui');
            ui.classList.remove('hidden');

            updateGeometry(calc.shape || 'torus');
            document.getElementById('advisor-content').innerText = `[NEURAL LINK] Analizând ${calc.name}. În contextul SkyTower Neo, se recomandă utilizarea materialelor cu rigiditate ridicată. Sugestie: Reduceți p0 cu 15% pentru optimizarea costurilor carbon-negative.`;

            ui.innerHTML = `
                <div class="space-y-10 animate-in fade-in slide-in-from-bottom-6 duration-700">
                    <div class="flex justify-between items-end">
                        <div>
                            <span class="px-3 py-1 rounded-full bg-indigo-100 text-indigo-600 text-[9px] font-black uppercase tracking-widest">${calc.cat}</span>
                            <h2 class="text-5xl font-black tracking-tighter text-slate-900 mt-4">${calc.name}</h2>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="saveSession()" class="p-5 glass rounded-2xl hover:bg-slate-900 hover:text-white transition shadow-sm"><i data-lucide="cloud-lightning" class="w-5 h-5"></i></button>
                            <button onclick="generateReport('${calc.id}')" class="p-5 bg-indigo-600 text-white rounded-2xl hover:bg-slate-900 transition shadow-xl"><i data-lucide="file-text" class="w-5 h-5"></i></button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                        <div class="space-y-6">
                            ${calc.params.map((p, i) => `
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center px-1">
                                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${p}</label>
                                        <span class="px-2 py-0.5 bg-slate-100 rounded text-[8px] font-mono text-slate-500">P${i} REGISTER</span>
                                    </div>
                                    <input type="number" id="param-${i}" class="w-full p-6 bg-white border border-slate-100 rounded-[1.8rem] font-black text-3xl focus:ring-8 focus:ring-indigo-500/5 transition-all outline-none" value="0" oninput="calculateResult('${id}')">
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="flex flex-col p-12 bg-slate-950 rounded-[3rem] text-white shadow-3xl relative overflow-hidden group border border-white/10">
                            <div class="absolute inset-0 opacity-10 pointer-events-none group-hover:opacity-20 transition-opacity">
                                <svg width="100%" height="100%"><pattern id="grid-v5" width="30" height="30" patternUnits="userSpaceOnUse"><path d="M 30 0 L 0 0 0 30" fill="none" stroke="white" stroke-width="0.5"/></pattern><rect width="100%" height="100%" fill="url(#grid-v5)" /></svg>
                            </div>
                            <div class="flex justify-between items-center z-10 mb-8">
                                <p class="text-[10px] font-black text-cyan-400 uppercase tracking-[0.4em]">Engine Output</p>
                                <i data-lucide="activity" class="w-4 h-4 text-cyan-400 animate-pulse"></i>
                            </div>
                            <div id="res-val" class="text-8xl font-black tracking-tighter z-10 shimmer-text">0.00</div>
                            <div id="res-unit" class="text-[9px] font-mono text-slate-500 mt-8 z-10 bg-white/5 p-4 rounded-2xl border border-white/5 uppercase tracking-[0.2em] leading-relaxed">System Idle: Waiting for quantum parameters...</div>
                            
                            <div class="mt-auto pt-12 z-10">
                                <div class="flex justify-between text-[10px] mb-3 font-black uppercase text-indigo-300">
                                    <span>Topological Load</span>
                                    <span id="load-pct">0%</span>
                                </div>
                                <div class="w-full h-3 bg-white/5 rounded-full overflow-hidden border border-white/5">
                                    <div id="res-progress" class="w-0 h-full bg-gradient-to-r from-indigo-500 to-cyan-400 transition-all duration-1000 shadow-[0_0_20px_rgba(99,102,241,0.5)]"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
            logAction('LOAD_MODULE', { name: calc.name });
        }

        function calculateResult(id) {
            const calc = calculators.find(c => c.id === id);
            const inputs = calc.params.map((_, i) => parseFloat(document.getElementById(`param-${i}`).value) || 0);
            
            try {
                const scope = {};
                inputs.forEach((v, i) => scope[`p${i}`] = v);
                const result = math.evaluate(calc.formula, scope);
                
                const displayVal = result.toLocaleString(undefined, {maximumFractionDigits: 4});
                document.getElementById('res-val').innerText = displayVal;
                document.getElementById('res-unit').innerText = "CALC_HASH :: " + btoa(displayVal).substring(0, 16).toUpperCase();
                
                const progress = Math.min(Math.abs(result) / 10, 100);
                document.getElementById('res-progress').style.width = progress + "%";
                document.getElementById('load-pct').innerText = Math.round(progress) + "%";
                document.getElementById('live-strain').innerText = (result * 0.00001).toFixed(6) + " ε";
                
                // 3D Reactivity 2026
                const s = 1 + (Math.sin(result) * 0.2);
                gsap.to(object.scale, { x: s, y: s, z: s, duration: 0.4, ease: "elastic.out(1, 0.3)" });
                
                if(result > 1000) {
                    logAction('THRESHOLD_ALERT', { value: result, module: calc.name });
                }
            } catch (e) {
                console.error("Neural engine error");
            }
        }

        // --- FORGE 2026 ---
        function openForge() { document.getElementById('forge-modal').classList.remove('hidden'); }
        function closeForge() { document.getElementById('forge-modal').classList.add('hidden'); }

        function buildModule() {
            const name = document.getElementById('forge-name').value;
            const formula = document.getElementById('forge-formula').value;
            const cat = document.getElementById('forge-cat').value;
            
            if(!name || !formula) return;

            const newId = name.toLowerCase().replace(/ /g, '-');
            calculators.push({
                id: newId,
                cat: cat,
                name: name,
                icon: 'brain-circuit',
                params: ['Factor Alpha', 'Load Beta', 'Delta Flux'],
                formula: formula,
                shape: 'octahedron'
            });

            renderLibrary();
            closeForge();
            logAction('FORGE_DEPLOY', { module: name, formula: formula });
        }

        // --- LOGGING & AUDIT ---
        function logAction(action, details) {
            const container = document.getElementById('audit-logs');
            const div = document.createElement('div');
            div.className = "p-5 glass rounded-[1.5rem] mb-3 border-l-4 border-indigo-600 animate-in slide-in-from-left-4";
            div.innerHTML = `
                <div class="flex justify-between font-black mb-2">
                    <span class="text-indigo-600 uppercase tracking-tighter">${action}</span>
                    <span class="text-slate-400 text-[9px]">${new Date().toISOString()}</span>
                </div>
                <div class="text-[10px] text-slate-500 font-mono break-all">${JSON.stringify(details)}</div>
            `;
            container.prepend(div);
        }

        function toggleAudit() { document.getElementById('audit-overlay').classList.toggle('hidden'); }

        function renderMaterials() {
            const container = document.getElementById('material-list');
            materials.forEach(m => {
                const div = document.createElement('div');
                div.className = "p-4 glass rounded-2xl flex items-center gap-4 hover:shadow-xl transition cursor-pointer border border-transparent hover:border-indigo-200 group";
                div.onclick = () => {
                    document.getElementById('advisor-content').innerText = m.advisor;
                    logAction('MATERIAL_INJECT', { name: m.name });
                };
                div.innerHTML = `
                    <div class="p-3 bg-white rounded-xl text-indigo-600 shadow-sm group-hover:rotate-12 transition-transform"><i data-lucide="${m.icon}" class="w-4 h-4"></i></div>
                    <div class="flex-1">
                        <p class="text-[11px] font-black text-slate-800">${m.name}</p>
                        <p class="text-[8px] text-slate-400 font-mono uppercase tracking-tighter">E: ${m.e} | ρ: ${m.density}</p>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- BOOT SYSTEM ---
        window.onload = () => {
            init3D();
            renderLibrary();
            renderMaterials();
            logAction('SYSTEM_BOOT', { version: '5.0.0-Quantum', kernel: 'Sentinel-V8', status: 'All systems nominal' });
            
            gsap.from(".glass", { opacity: 0, y: 30, duration: 1.2, stagger: 0.1, ease: "expo.out" });
        };

        window.onresize = () => {
            const container = document.getElementById('three-container');
            renderer.setSize(container.clientWidth, container.clientHeight);
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
        };

        function generateReport(id) {
            const calc = calculators.find(c => c.id === id);
            alert(`ANALYSIS MANIFEST GENERATED\nProject: SkyTower Neo\nModule: ${calc.name}\nStatus: Verified 2026\nChecksum: ${Math.random().toString(36).substring(7).toUpperCase()}`);
            logAction('REPORT_GEN', { id, type: 'Technical Manifest' });
        }

        function saveSession() {
            logAction('SESSION_SYNC', { status: 'Neural Cloud Synchronized' });
            alert("Sesiunea a fost sincronizată cu succes în Neural Cloud (SkyTower Neo Project).");
        }

        function filterModules() {
            renderLibrary(document.getElementById('searchModules').value);
        }
    </script>
</body>
</html>
